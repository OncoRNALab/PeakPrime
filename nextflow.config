includeConfig "$projectDir/params.config"
// Specify the work directory
def scratch_dir =   System.getenv("VSC_SCRATCH_PROJECTS_BASE") ? "${System.getenv("VSC_SCRATCH_PROJECTS_BASE")}/$tier1_project" : // Tier 1 scratch
                    System.getenv("VSC_SCRATCH_VO_USER") ?: // VO scratch
                    System.getenv("VSC_SCRATCH") // user scratch
 
// Specify the work directory
workDir = "$scratch_dir/work"

profiles { 
  pbs {
    conda.enabled = true
    process.conda = true
    conda.useMamba = false  // Use pure conda (mamba not available)
    conda.createTimeout = '2h'  // Increased timeout for environment creation
    conda.channels = ['conda-forge', 'bioconda', 'defaults']
    conda.channelPriority = 'strict'  // Required for conda 25.x compatibility
    conda.createOptions = '--override-channels'  // Required for conda 25.x compatibility
    process.executor = 'pbs'
    process.cpus = 1
    process.memory = '4 GB'
    process.time = '1h'
  }
  
  local {
    conda.enabled = true
    process.conda = true
    conda.useMamba = false  // Use pure conda (mamba not available)
    conda.createTimeout = '2h'  // Increased timeout for environment creation
    conda.channels = ['conda-forge', 'bioconda', 'defaults']
    conda.channelPriority = 'strict'  // Required for conda 25.x compatibility
    conda.createOptions = '--override-channels'  // Required for conda 25.x compatibility
    process.executor = 'local'
    process.cpus = 1
    process.memory = '4 GB'
  }
}

// Process-specific resource requirements
process {
  withName: ANALYZE_PRIMER_ALIGNMENTS {
    memory = '8 GB'
    time = '30m'
  }
  
  withName: MACS2_CALLPEAK {
    memory = '8 GB'
    time = '1h'
  }
  
  withName: PROCESS_MACS2_PEAKS {
    memory = '4 GB'
    time = '30m'
  }
  
  withName: EXTRACT_CDNA_PRIMERS {
    memory = '4 GB'
    time = '15m'
  }
  
  // Plotting optimization: enable parallel execution
  withName: MAKEPLOTS_NEW {
    maxForks = 4      // Run 4 plots simultaneously
    cpus = 1
    memory = '3 GB'   // Increased for BigWig caching
    time = '15m'
  }
}
params.outdir = 'results'