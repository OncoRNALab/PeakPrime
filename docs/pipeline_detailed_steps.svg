<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1100" viewBox="0 0 1400 1100">
  <style>
    .title { font: 700 24px/1.2 "Segoe UI", Roboto, Arial; fill: #1a1a1a }
    .subtitle { font: 400 14px/1.2 "Segoe UI", Roboto, Arial; fill: #555 }
    .node { fill: #ffffff; stroke: #2563eb; stroke-width: 2.5; rx: 8 }
    .input-node { fill: #dbeafe; stroke: #1e40af; stroke-width: 2.5; rx: 8 }
    .process-node { fill: #e0f2fe; stroke: #0284c7; stroke-width: 2.5; rx: 8 }
    .output-node { fill: #dcfce7; stroke: #16a34a; stroke-width: 2.5; rx: 8 }
    .final-node { fill: #fef3c7; stroke: #ca8a04; stroke-width: 2.5; rx: 8 }
    .arrow { stroke: #475569; stroke-width: 2.5; fill: none; marker-end: url(#arrowhead) }
    .arrow-optional { stroke: #94a3b8; stroke-width: 2; fill: none; marker-end: url(#arrowhead-light); stroke-dasharray: 5,5 }
    .step-label { font: 700 16px/1.1 "Segoe UI", Roboto, Arial; fill: #0f172a }
    .text { font: 600 13px/1.1 "Segoe UI", Roboto, Arial; fill: #1e293b }
    .small { font: 400 11px/1.2 "Segoe UI", Roboto, Arial; fill: #475569 }
    .tool { font: 400 10px/1.2 "Consolas", "Monaco", monospace; fill: #64748b }
    .section-title { font: 700 18px/1.2 "Segoe UI", Roboto, Arial; fill: #334155 }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <path d="M0,0 L10,3.5 L0,7 z" fill="#475569" />
    </marker>
    <marker id="arrowhead-light" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <path d="M0,0 L10,3.5 L0,7 z" fill="#94a3b8" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">PeakPrime Pipeline ‚Äî Step-by-Step Flow</text>
  <text x="700" y="55" text-anchor="middle" class="subtitle">RNA-seq peak detection, primer design, and QC workflow</text>

  <!-- INPUTS SECTION -->
  <text x="40" y="95" class="section-title">üì• Inputs (Step 1)</text>
  
  <rect x="40" y="110" width="180" height="85" class="input-node" />
  <text x="130" y="135" text-anchor="middle" class="step-label">BAM File</text>
  <text x="130" y="152" text-anchor="middle" class="small">Pre-aligned, sorted</text>
  <text x="130" y="167" text-anchor="middle" class="small">+ index (.bai)</text>
  <text x="130" y="182" text-anchor="middle" class="tool">sample.bam</text>

  <rect x="240" y="110" width="180" height="85" class="input-node" />
  <text x="330" y="135" text-anchor="middle" class="step-label">Gene List</text>
  <text x="330" y="152" text-anchor="middle" class="small">Ensembl IDs</text>
  <text x="330" y="167" text-anchor="middle" class="small">One per line</text>
  <text x="330" y="182" text-anchor="middle" class="tool">targets.txt</text>

  <rect x="440" y="110" width="180" height="85" class="input-node" />
  <text x="530" y="135" text-anchor="middle" class="step-label">GTF (optional)</text>
  <text x="530" y="152" text-anchor="middle" class="small">Gene annotation</text>
  <text x="530" y="167" text-anchor="middle" class="small">Auto-detected</text>
  <text x="530" y="182" text-anchor="middle" class="tool">annotation.gtf</text>

  <!-- PIPELINE CORE SECTION -->
  <text x="40" y="240" class="section-title">‚öôÔ∏è Core Pipeline Steps</text>

  <!-- Step 2: Coverage -->
  <rect x="40" y="260" width="260" height="90" class="process-node" />
  <text x="170" y="285" text-anchor="middle" class="step-label">Step 2: Coverage Generation</text>
  <text x="170" y="305" text-anchor="middle" class="small">Create per-base coverage tracks</text>
  <text x="170" y="320" text-anchor="middle" class="tool">deepTools bamCoverage</text>
  <text x="170" y="335" text-anchor="middle" class="text">‚Üí sample.bw</text>

  <!-- Step 3: Peak Calling -->
  <rect x="340" y="260" width="260" height="90" class="process-node" />
  <text x="470" y="285" text-anchor="middle" class="step-label">Step 3: Peak Calling</text>
  <text x="470" y="305" text-anchor="middle" class="small">Call statistically significant peaks</text>
  <text x="470" y="320" text-anchor="middle" class="tool">MACS2 callpeak</text>
  <text x="470" y="335" text-anchor="middle" class="text">‚Üí *_peaks.narrowPeak</text>

  <!-- Step 4: QC & Selection -->
  <rect x="640" y="260" width="260" height="90" class="process-node" />
  <text x="770" y="285" text-anchor="middle" class="step-label">Step 4: Peak QC & Selection</text>
  <text x="770" y="305" text-anchor="middle" class="small">Score & rank peaks per gene</text>
  <text x="770" y="320" text-anchor="middle" class="tool">pick_peaks.R</text>
  <text x="770" y="335" text-anchor="middle" class="text">‚Üí peaks_qc_summary.tsv</text>

  <!-- Arrows for steps 2-4 -->
  <path d="M130,195 L130,260" class="arrow" />
  <path d="M300,305 L340,305" class="arrow" />
  <path d="M600,305 L640,305" class="arrow" />

  <!-- PRIMER DESIGN SECTION -->
  <text x="40" y="400" class="section-title">üß¨ Primer Design & Specificity Check</text>

  <!-- Step 5: Primer Design -->
  <rect x="940" y="260" width="260" height="90" class="process-node" />
  <text x="1070" y="285" text-anchor="middle" class="step-label">Step 5: Primer Design</text>
  <text x="1070" y="305" text-anchor="middle" class="small">Design candidate primers</text>
  <text x="1070" y="320" text-anchor="middle" class="tool">primer3_core</text>
  <text x="1070" y="335" text-anchor="middle" class="text">‚Üí primers.tsv, primers.fasta</text>

  <!-- Step 6: Alignment -->
  <rect x="940" y="380" width="260" height="90" class="process-node" />
  <text x="1070" y="405" text-anchor="middle" class="step-label">Step 6: Primer Alignment</text>
  <text x="1070" y="425" text-anchor="middle" class="small">Check specificity & off-targets</text>
  <text x="1070" y="440" text-anchor="middle" class="tool">bowtie -v 2 -a</text>
  <text x="1070" y="455" text-anchor="middle" class="text">‚Üí alignments.sam</text>

  <!-- Step 7: Alignment Summary -->
  <rect x="940" y="500" width="260" height="90" class="process-node" />
  <text x="1070" y="525" text-anchor="middle" class="step-label">Step 7: Alignment Summary</text>
  <text x="1070" y="545" text-anchor="middle" class="small">Count perfect/mismatch hits</text>
  <text x="1070" y="560" text-anchor="middle" class="tool">analyze_primer_alignments.py</text>
  <text x="1070" y="575" text-anchor="middle" class="text">‚Üí primer_alignment_summary.tsv</text>

  <!-- Step 8: Best Primer Selection -->
  <rect x="940" y="620" width="260" height="90" class="process-node" />
  <text x="1070" y="645" text-anchor="middle" class="step-label">Step 8: Select Best Primer</text>
  <text x="1070" y="665" text-anchor="middle" class="small">Pick primers with perfect match</text>
  <text x="1070" y="680" text-anchor="middle" class="tool">select_best_primer.py</text>
  <text x="1070" y="695" text-anchor="middle" class="text">‚Üí selected_primers.tsv</text>

  <!-- Arrows for alignment -->
  <path d="M900,305 L940,305" class="arrow" />
  <path d="M1070,350 L1070,380" class="arrow" />
  <path d="M1070,470 L1070,500" class="arrow" />
  <path d="M1070,590 L1070,620" class="arrow" />

  <!-- POSTPROCESSING SECTION -->
  <text x="40" y="780" class="section-title">üì¶ Postprocessing for Shiny App</text>

  <!-- Step 9: Preprocessing -->
  <rect x="340" y="800" width="320" height="100" class="process-node" />
  <text x="500" y="825" text-anchor="middle" class="step-label">Step 9: RDS Conversion</text>
  <text x="500" y="845" text-anchor="middle" class="small">Convert TSV/BW ‚Üí fast RDS bundles</text>
  <text x="500" y="860" text-anchor="middle" class="tool">preprocess_for_standalone.R</text>
  <text x="500" y="875" text-anchor="middle" class="text">‚Üí qc_data.rds, coverage_index.rds,</text>
  <text x="500" y="890" text-anchor="middle" class="text">gtf_data.rds, data_manifest.rds</text>

  <!-- Arrows to preprocessing -->
  <path d="M770,350 L770,750 L500,750 L500,800" class="arrow" />
  <path d="M1070,710 L1070,750 L660,750 L660,800" class="arrow-optional" />

  <!-- Step 10: Shiny App -->
  <rect x="340" y="930" width="320" height="100" class="final-node" />
  <text x="500" y="955" text-anchor="middle" class="step-label">Step 10: Shiny Explorer App</text>
  <text x="500" y="975" text-anchor="middle" class="small">Interactive gene/primer visualization</text>
  <text x="500" y="990" text-anchor="middle" class="tool">app_standalone.R</text>
  <text x="500" y="1005" text-anchor="middle" class="text">‚úì Plot viewer   ‚úì Primer alignment tab</text>
  <text x="500" y="1020" text-anchor="middle" class="text">‚úì CSV/PNG export   ‚úì Multi-peak view</text>

  <!-- Arrow to app -->
  <path d="M500,900 L500,930" class="arrow" />

  <!-- KEY/LEGEND -->
  <rect x="1050" y="800" width="300" height="230" fill="#f8fafc" stroke="#cbd5e1" stroke-width="2" rx="8" />
  <text x="1200" y="825" text-anchor="middle" class="step-label">Legend</text>
  
  <rect x="1070" y="840" width="60" height="30" class="input-node" />
  <text x="1145" y="860" class="small">Input files (BAM, genes, GTF)</text>
  
  <rect x="1070" y="880" width="60" height="30" class="process-node" />
  <text x="1145" y="900" class="small">Processing steps (tools)</text>
  
  <rect x="1070" y="920" width="60" height="30" class="output-node" />
  <text x="1145" y="940" class="small">Output files (TSV, BW, etc.)</text>
  
  <rect x="1070" y="960" width="60" height="30" class="final-node" />
  <text x="1145" y="980" class="small">Final deliverable (Shiny app)</text>
  
  <path d="M1070,1005 L1130,1005" class="arrow-optional" />
  <text x="1145" y="1010" class="small">Optional step</text>

  <!-- FOOTER NOTE -->
  <text x="40" y="1070" class="small" font-weight="600">Note: The pipeline requires pre-aligned BAM files. If you have FASTQ, align first using STAR or HISAT2.</text>
  <text x="40" y="1088" class="small">For detailed parameters and examples, see docs/pipeline_steps.md</text>

</svg>
